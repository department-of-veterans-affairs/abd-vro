plugins {
  id 'local.python.app-conventions'
  id 'local.python.container-service-conventions'
}

tasks.register('mypy', PythonTask) {
  module = 'mypy'
  command = 'src'
  dependsOn 'requirements'
}

tasks.register('isort', PythonTask) {
  module = 'isort'
  command = '.'
  dependsOn 'mypy'
}

tasks.register('ruff', PythonTask) {
  module = 'ruff'
  command = 'check'
  dependsOn 'isort'
}

tasks.register('appinstall', PythonTask) {
  module = 'pip'
  command = 'install -e .'
  dependsOn 'ruff'
}

// Override the pytest task in local.python.app-conventions to remove dependency on pyflake8
tasks.getByPath('pytest').configure {
  dependsOn.clear()
  dependsOn 'appinstall'
}

// Runs pytest integration tests when './gradlew integration-test' is run
tasks.register('integrationPytest', PythonTask) {
  dependsOn 'appinstall'
  module = 'pytest'
  command = './integration --no-cov'
}

tasks.register('integrationTest', Test) {
  dependsOn 'integrationPytest'
  group = 'verification'
}

// Runs pytest end-to-end tests when './gradlew integration-test' is run
tasks.register('endToEndPytest', PythonTask) {
  dependsOn 'appinstall'
  module = 'pytest'
  command = './end_to_end --no-cov'
}

tasks.register('endToEndTest', Test) {
  dependsOn 'endToEndPytest'
  group = 'verification'
}
