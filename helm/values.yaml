# Best practices: https://helm.sh/docs/chart_best_practices/values/

# Normal state:
rabbitmq:
  enabled: true
postgres:
  enabled: true
redis:
  enabled: true
vro-app:
  enabled: true
# Enable as needed:
console:
  enabled: false

# This file makes extensive use of YAML Anchors to reduce repetition.

# global (reserved keyword) allows all subcharts to access values using .Values.global.someKey
# However, this makes the subchart less independent: https://itnext.io/helm-3-umbrella-charts-global-values-in-sub-charts-666437d4ed28
# so don't use .Values.global.someKey. Instead, use '<<: *anchor-global'
# To override a setting on commandline: helm --set-string "global.someKey=someValue" ...
global:
  # ================= Constants =================
  # Should be referenced as .Values.global.someParam

  # name cannot have underscore
  # Used as imagePullSecrets, secretKeyRef.name, container name prefixes,
  # virtual-service's uri.prefix and for env vars: SERVER_SERVLET_CONTEXTPATH, STARTER_OPENAPI_SERVERURL
  #name: abd-vro
  hostnamePrefix: vro

  # Persistent Volumes
  pgdata:
    pvcName: pgdata-persistent-storage
    claimName: vro-pgdata-efs-claim
    mountPath: /persist/postgres
    storageSize: 2Gi
    # EBS volumes require podAffinity, which relies on labels
    labels:
      volume: database
  tracking:
    pvcName: tracking-persistent-storage
    claimName: vro-tracking-efs-claim
    mountPath: /persist/tracking
    storageSize: 1Gi

  # Not used: cluster: nonprod

  # ================= Parameters =================
  # Should be referenced as .Values.global.someParam

  # environment is overridden by deploy scripts with $ENV values like dev, qa, prod
  environment: dev

  # TODO: replace with images.tag or subchart's image.tag?
  # version is used in annotations for APP
  version: 0.1

  images:
    pullSecretsName: abd-vro-ghcr
    repo: abd-vro
    # tag is used to set the default image tag for all VRO images
    tag: "someGlobalTag"
    services:
      uriPrefix: vro
      environment: nonprod # for APP

  # endpoint is api if ENV==prod; otherwise dev
  # Used by virtual-service's hosts
  endpoint: dev
  # ================= Parameters =================


  service:
    app:
      sourcePort: 8080
      targetPort: 8080
    db:
      sourcePort: 5432
      targetPort: 5432
      databaseName: vro
      schemaName: claims
    mq:
      sourcePort: 5672
      targetPort: 5672
    redis:
      sourcePort: 6379
      targetPort: 6379

#  api:
#    apiKeySecret: api
#    apiKey01: apiKey01
#    apiKey02: apiKey02
#    vroNonProdKey: vroNonProd

  rabbitmq:
    secretKeyRef:
      name: rabbitmq
      usernameKey: User
      passwordKey: Pass

  redis:
    secretKeyRef:
      name: redis
      passwordKey: redisPassword

  postgres:
    secretKeyRef:
      name: postgres
      urlKey: url
      usernameKey: username
      passwordKey: password
      dbnameKey: dbName
      schemaKey: schema
#    dbName: vro
#    initDbName: vro
#    initUsernameKey: initUsername
#    initPasswordKey: initPassword

  dbinit:
    secretKeyRef:
      name: dbinit
      # DB super user; TODO: why isn't this in the postgres.secretKeyRef?
      superUsernameKey: superUsername
      superPasswordKey: superPassword
      # TODO: Do the values for the following always match postgres.secretKeyRef.usernameKey and passwordKey?
      usernameKey: username
      passwordKey: password
      urlKey: url
    # superDbnameKey: superDbname

# To test:
#   helm upgrade --install vro-test helm -n va-abd-rrd-dev --set-string global.images.tag=latest --set console.enabled=true --debug
#   helm upgrade --install vro-test helm -n va-abd-rrd-dev --set rabbitmq.enabled=true --debug
