---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Values.labels.pdfGenerator.app }}
  labels: {{- toYaml .Values.labels.pdfGenerator | nindent 4 }}
  annotations:
    app.kubernetes.io/name: {{ .Values.labels.pdfGenerator.app }}
    app.kubernetes.io/version: {{ .Values.version | quote }}
    app.kubernetes.io/owner: {{ .Values.owner }}
    app.kubernetes.io/env: {{ .Values.environment }}
spec:
  replicas: {{ .Values.replicaCount }}
  selector:
    matchLabels: {{- toYaml .Values.labels.pdfGenerator | nindent 6 }}
  template:
    metadata:
      labels: {{- toYaml .Values.labels.pdfGenerator | nindent 8 }}
      annotations:
        app.kubernetes.io/podname: {{ .Values.labels.pdfGenerator.app }}
        app.kubernetes.io/podversion: {{ .Values.version | quote }}
        app.kubernetes.io/podowner: {{ .Values.owner }}
        app.kubernetes.io/podenv: {{ .Values.environment }}
    spec:
      imagePullSecrets:
        - name: {{ .Values.name }}-ghcr
      containers:
        - name: {{ .Values.labels.pdfGenerator.app }}
          image: {{ .Values.images.registry }}/{{ .Values.images.org }}/{{ .Values.images.repo }}/{{ .Values.images.pdfGenerator.imageName }}:{{ .Values.images.pdfGenerator.tag }}
          imagePullPolicy: {{ .Values.images.pdfGenerator.imagePullPolicy }}
          env:
            - name: JAVA_OPTS
              value: -Xmx512m
            - name: SPRING_DATASOURCE_URL
              value: jdbc:postgresql://{{ .Chart.Name }}-postgres:{{ .Values.service.db.targetPort }}/{{ .Values.postgres.dbName }}
            - name: SPRING_DATASOURCE_USERNAME
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.postgres.secretName }}
                  key: {{ .Values.postgres.usernameKey }}
            - name: SPRING_DATASOURCE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.postgres.secretName }}
                  key: {{ .Values.postgres.passwordKey }}
            - name: SPRING_DATASOURCE_HIKARI_JDBCURL
              value: $(SPRING_DATASOURCE_URL)
            - name: SPRING_DATASOURCE_HIKARI_USERNAME
              value: $(SPRING_DATASOURCE_USERNAME)
            - name: SPRING_DATASOURCE_HIKARI_PASSWORD
              value: $(SPRING_DATASOURCE_PASSWORD)
            - name: SERVER_SERVLET_CONTEXTPATH
              value: /{{ .Values.name }}
            - name: STARTER_OPENAPI_SERVERURL
              value: /{{ .Values.name }}
          resources: {{- toYaml .Values.resources.pythonPdfGenerator | nindent 12 }}
#        - name: {{ .Values.name }}-assess-claim-dc7101
#          image: {{ .Values.images.registry }}/{{ .Values.images.org }}/{{ .Values.images.repo }}/{{ .Values.images.assessClaimDC7101.imageName }}:{{ .Values.images.assessClaimDC7101.tag }}
#          imagePullPolicy: {{ .Values.images.assessClaimDC7101.imagePullPolicy }}
#          resources: {{- toYaml .Values.resources.assessClaimDC7101 | nindent 12 }}
#        - name: {{ .Values.name }}-pdf-generator
#          image: {{ .Values.images.registry }}/{{ .Values.images.org }}/{{ .Values.images.repo }}/{{ .Values.images.pdfGenerator.imageName }}:{{ .Values.images.pdfGenerator.tag }}
#          imagePullPolicy: {{ .Values.images.pdfGenerator.imagePullPolicy }}
#          env:
#            - name: RABBITMQ_PLACEHOLDERS_HOST
#              value: {{ .Chart.Name }}-rabbitmq
#            - name: RABBITMQ_PLACEHOLDERS_USERNAME
#              valueFrom:
#                secretKeyRef:
#                  name: {{ .Values.rabbitmq.secretName }}
#                  key: {{ .Values.rabbitmq.usernameKey }}
#            - name: RABBITMQ_PLACEHOLDERS_USERPASSWORD
#              valueFrom:
#                secretKeyRef:
#                  name: {{ .Values.rabbitmq.secretName }}
#                  key: {{ .Values.rabbitmq.passwordKey }}
#          resources: {{- toYaml .Values.resources.pythonPdfGenerator | nindent 12 }}
