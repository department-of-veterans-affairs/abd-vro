# This file contains shared properties across all environments; it is always loaded by Spring
# See https://github.com/department-of-veterans-affairs/abd-vro/wiki/Configuration-settings#vros-use-of-spring-profiles

management:
  endpoints.web:
    exposure.include: "*"
  endpoint:
    health:
      show-details: always
      probes:
        enabled: true
      group:
        liveness.include: livenessState
        readiness.include: readinessState, db
  metrics:
    enabled: true
    distribution:
      percentiles.http.server.requests: 0.5, 0.90, 0.95, 0.99, 0.999
      percentiles-histogram.http.server.requests: true
      sla.http.server.requests: 10ms, 50ms
      slo.http.server.requests: 10ms, 50ms
    tags:
      group: starter
      service: example
      region: "${POD_REGION:local}"
      stack: "${CLUSTER:dev}"
      ns: "${NAMESPACE:example}"
      pod: "${POD_ID:docker}"
    web.server.request.autotime.enabled: true
  server.port: 8061

server:
  ssl:
    enabled: false
  port: 8060
  maxHttpHeaderSize: 48000
  session:
    timeout: 60
  connection:
    timeout: 60000
  servlet:
    session:
      timeout: 120000
  # Needed to handle Swagger error: https://stackoverflow.com/questions/70906081/springboot-swagger3-failed-to-load-remote-configuration
  # https://stackoverflow.com/questions/68318269/spring-server-forward-headers-strategy-native-vs-framework
  forward-headers-strategy: framework

spring:
  application:
    name: "vro-api"
  servlet:
    multipart:
      maxFileSize: 25MB
      maxRequestSize: 25MB
      enabled: true
    session:
      timeout: 120000
  resources:
    add-mappings: false
  http:
    encoding:
      force: true

springdoc:
  writer-with-default-pretty-printer: true
  show-actuator: true
  swagger-ui:
    # http://localhost:8060/swaggerui will be forwarded to http://localhost:8060/webjars/swagger-ui/index.html
    # Doesn't account for context-path: path: /swaggerui
    operations-sorter: method
    tagsSorter: alpha
    # Populate API dropdown on the upper-right of Swagger UI
    urls:
      - name: 0. Gateway API
        # API defined for this API Gateway
        # TODO: convert /abd-vro into a variable
        url: /abd-vro/v3/api-docs
      - name: App API
        # API defined for the VRO Java-base App
        url: /abd-vro-app/v3/api-docs
      - name: Contention Classification API
        # Use the route defined under spring.cloud.gateway below
        url: /abd-vro-contention-classification/openapi.json

# TODO: Move this to application-local.yml
spring.cloud.gateway:
  actuator.verbose.enabled: true
  discovery:
    locator:
      enabled: false
  routes:
  # Each domain API should have one entry with a URI prefix
  # Be aware: https://github.com/spring-cloud/spring-cloud-gateway/issues/1759
  # because SPRING_WEBFLUX_BASEPATH is set in Helm configuration
  - id: vro-configurable
    uri: ${VRO_GW_ROUTE_URI}
    predicates:
    - Path=${VRO_GW_ROUTE_PREDICATE}
    filters:
    - RewritePath=${VRO_GW_ROUTE_REWRITE}/(?<path>.*), /$\{path}
  - id: gateway-route
    uri: http://${VRO_APP_HOSTNAME:localhost:8060}
    predicates:
    - Path=/abd-vro/**
    filters:
    - RewritePath=/abd-vro/(?<path>.*), /$\{path}
  - id: app-route
    uri: http://${VRO_APP_HOSTNAME:localhost:8080}
    predicates:
    - Path=/abd-vro-app/**
    filters:
    - RewritePath=/abd-vro-app/(?<path>.*), /$\{path}
  - id: contention-classification-route
    # TODO: add Swagger servers such that /contention-classification is used as the prefix for requests
    uri: http://${VRO_CC_HOSTNAME:localhost:18000}
    predicates:
    - Path=/abd-vro-contention-classification/**
    filters:
    - RewritePath=/abd-vro-contention-classification/(?<path>.*), /$\{path}

#logging:
#  level:
#    org.springframework.cloud.gateway: DEBUG

log4j2:
  formatMsgNoLookups: true

vro:
  openapi:
    info:
      title: "Automated Benefits Delivery (ABD): Virtual Regional Office (VRO) API"
      description: "To improve benefit delivery to Veterans"
      version: "3.0.0"
      contact:
        name: Premal Shah
        email: "premal.shah@va.gov"
      license:
        name: CCO 1.0
        url: "https://github.com/department-of-veterans-affairs/abd-vro/blob/master/LICENSE.md"
    servers:
      -
        description: "Server"
        url: ${STARTER_OPENAPI_SERVERURL:/}
