version: '3.9'

networks:
  internal:
  external:

volumes:
  pgdata:

services:
  rabbitmq1:
    image: rabbitmq:3-management
    healthcheck:
      test: rabbitmq-diagnostics check_port_connectivity
      interval: 5s
      timeout: 3s
      retries: 30
    hostname: rabbitmq1
    expose:
      - "5672"
      - "15672"
    networks:
      - internal
    ports:
      - "5672:5672"
      - "15672:15672"

  redis1:
    image: redis
    hostname: redis1
    expose:
      - "6379"
    networks:
      - internal
    ports:
      - "6379:6379"

  postgres1:
    image: postgres
    hostname: postgres1
    expose:
      - "5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: vro
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - internal
# NOTE, security favors removing external access from the database container
      - external
    ports:
      - "5432:5432"

  db-init:
    image: va/abd_vro-db-init:latest
    depends_on:
      - postgres1
    networks:
      - internal

  abd_vro:
    image: va/abd_vro-app:latest
    hostname: abd_vro
    ports:
      - "8080:8080"
      - "8081:8081"
    environment:
      JAVA_PROFILE: "-Dspring.profiles.include=compose"
      # TODO: move these RabbitMQ configurations into a reusable yaml block
      RABBITMQ_PLACEHOLDERS_HOST: rabbitmq1
      RABBITMQ_PLACEHOLDERS_USERNAME: ${RABBITMQ_USERNAME}
      RABBITMQ_PLACEHOLDERS_USERPASSWORD: ${RABBITMQ_PASSWORD}
    depends_on:
      - postgres1
      - rabbitmq1
      - redis1
      - db-init
      - assess-claim-dc7101
      - assess-claim-dc6602
      - pdf-generator
    networks:
      - internal
      - external

  assess-claim-dc7101:
    image: va/abd_vro-assessclaimdc7101:latest
    environment:
      RABBITMQ_PLACEHOLDERS_HOST: rabbitmq1
      RABBITMQ_PLACEHOLDERS_USERNAME: ${RABBITMQ_USERNAME}
      RABBITMQ_PLACEHOLDERS_USERPASSWORD: ${RABBITMQ_PASSWORD}
    depends_on:
      - rabbitmq1
    networks:
      - internal

  assess-claim-dc6602:
    image: va/abd_vro-assessclaimdc6602:latest
    environment:
      RABBITMQ_PLACEHOLDERS_HOST: rabbitmq1
      RABBITMQ_PLACEHOLDERS_USERNAME: ${RABBITMQ_USERNAME}
      RABBITMQ_PLACEHOLDERS_USERPASSWORD: ${RABBITMQ_PASSWORD}
    depends_on:
      - rabbitmq1
    networks:
      - internal

  pdf-generator:
    image: va/abd_vro-pdfgenerator:latest
    environment:
      RABBITMQ_PLACEHOLDERS_HOST: rabbitmq1
      RABBITMQ_PLACEHOLDERS_USERNAME: ${RABBITMQ_USERNAME}
      RABBITMQ_PLACEHOLDERS_USERPASSWORD: ${RABBITMQ_PASSWORD}
      REDIS_PLACEHOLDERS_HOST: redis1
    depends_on:
      - rabbitmq1
      - redis1
    networks:
      - internal

  service-data-access:
    image: va/abd_vro-service-data-access:latest
    environment:
      RABBITMQ_PLACEHOLDERS_HOST: rabbitmq1
      RABBITMQ_PLACEHOLDERS_USERNAME: ${RABBITMQ_USERNAME}
      RABBITMQ_PLACEHOLDERS_USERPASSWORD: ${RABBITMQ_PASSWORD}
      LH_CLIENT_ID: 0oah28rb5jLj4NeSN2p7
      LH_ASSERTION_URL: https://deptva-eval.okta.com/oauth2/aus8nm1q0f7VQ0a482p7/v1/token
      LH_TOKEN_URL: https://sandbox-api.va.gov/oauth2/health/system/v1/token
      LH_FHIR_URL: https://sandbox-api.va.gov/services/fhir/v0/r4
    depends_on:
      rabbitmq1:
        condition: service_healthy
    networks:
      - internal
