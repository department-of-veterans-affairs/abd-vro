version: '3.9'

networks:
  internal:
  external:

volumes:
  pgdata:

services:
  # opa:
  #   image: openpolicyagent/opa
  #   hostname: opa
  #   expose:
  #     - "8181"
  #   ports:
  #     - "8181:8181"
  #   command:
  #     - run
  #     - --server
  #     - --log-level
  #     - debug
  #   networks:
  #     - internal
  #     - external

  rabbitmq1:
    image: rabbitmq:3-management
    healthcheck:
      test: rabbitmq-diagnostics check_port_connectivity
      interval: 5s
      timeout: 3s
      retries: 30
    hostname: rabbitmq1
    expose:
      - "5672"
      - "15672"
    networks:
      - internal
    ports:
      - "5672:5672"
      - "15672:15672"

  redis1:
    image: redis
    hostname: redis1
    expose:
      - "6379"
    networks:
      - internal
    ports:
      - "6379:6379"

  postgres1:
    image: postgres
    hostname: postgres1
    expose:
      - "5432"
    environment:
      POSTGRES_USER: vro_user
      POSTGRES_PASSWORD: not-the-password
      POSTGRES_DB: vro
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - internal
# NOTE, security favors removing external access from the database container
      - external
    ports:
      - "5432:5432"

  db-init:
    image: va/abd_vro-db-init:latest
    depends_on:
      - postgres1
    networks:
      - internal

  # opa-init:
  #   image: va/abd_vro-opa-init:latest
  #   depends_on:
  #     - opa
  #   networks:
  #     - internal

  abd_vro:
    image: va/abd_vro-app:latest
    hostname: abd_vro
    ports:
      - "8080:8080"
      - "8081:8081"
    environment:
      POSTGRES_HOST: postgres1
      POSTGRES_DBNAME: vro
      POSTGRES_USER: example_service
      POSTGRES_PASSWORD: also-not-the-service-password
      JAVA_PROFILE: "-Dspring.profiles.include=compose"
      # TODO: move these RabbitMQ configurations into a reusable yaml block
      RABBITMQ_PLACEHOLDERS_HOST: rabbitmq1
      RABBITMQ_PLACEHOLDERS_USERNAME: guest
      RABBITMQ_PLACEHOLDERS_USERPASSWORD: guest
    depends_on:
      - postgres1
      - rabbitmq1
      - redis1
      - db-init
      - assess-claim-dc7101
      - assess-claim-dc6602
      - pdf-generator
    networks:
      - internal
      - external

  assess-claim-dc7101:
    image: va/abd_vro-assessclaimdc7101:latest
    environment:
      RABBITMQ_PLACEHOLDERS_HOST: rabbitmq1
      RABBITMQ_PLACEHOLDERS_USERNAME: guest
      RABBITMQ_PLACEHOLDERS_USERPASSWORD: guest
    depends_on:
      rabbitmq1:
        condition: service_healthy
    networks:
      - internal

  assess-claim-dc6602:
    image: va/abd_vro-assessclaimdc6602:latest
    environment:
      RABBITMQ_PLACEHOLDERS_HOST: rabbitmq1
      RABBITMQ_PLACEHOLDERS_USERNAME: guest
      RABBITMQ_PLACEHOLDERS_USERPASSWORD: guest
    depends_on:
      rabbitmq1:
        condition: service_healthy
    networks:
      - internal

  pdf-generator:
    image: va/abd_vro-pdfgenerator:latest
    environment:
      RABBITMQ_PLACEHOLDERS_HOST: rabbitmq1
      RABBITMQ_PLACEHOLDERS_USERNAME: guest
      RABBITMQ_PLACEHOLDERS_USERPASSWORD: guest
      REDIS_PLACEHOLDERS_HOST: redis1
    depends_on:
      redis1:
      rabbitmq1:
        condition: service_healthy
    networks:
      - internal

  service-data-access:
    image: va/abd_vro-service-data-access:latest
    environment:
      RABBITMQ_PLACEHOLDERS_HOST: rabbitmq1
      RABBITMQ_PLACEHOLDERS_USERNAME: guest
      RABBITMQ_PLACEHOLDERS_USERPASSWORD: guest
      LH_CLIENT_ID: 0oah28rb5jLj4NeSN2p7
      LH_ASSERTION_URL: https://deptva-eval.okta.com/oauth2/aus8nm1q0f7VQ0a482p7/v1/token
      LH_TOKEN_URL: https://sandbox-api.va.gov/oauth2/health/system/v1/token
      LH_FHIR_URL: https://sandbox-api.va.gov/services/fhir/v0/r4
    depends_on:
      rabbitmq1:
        condition: service_healthy
    networks:
      - internal

#   jaeger:
#     image: jaegertracing/all-in-one:1.20
#     hostname: jaeger
#     ports:
#       - "5775:5775/udp"
#       - "6831:6831/udp"
#       - "6832:6832/udp"
#       - "5778:5778"
#       - "16686:16686"
#       - "14268:14268"
#       - "14250:14250"
#     environment:
#       COLLECTOR_ZIPKIN_HTTP_PORT : "9411"
#     networks:
#       - internal
#       - external

#   zookeeper:
#     image: wurstmeister/zookeeper
#     hostname: zookeeper
#     ports:
#       - "2181:2181"
#     networks:
#       - internal

#   kafka:
#     image: wurstmeister/kafka
#     hostname: kafka
#     ports:
#       - "9092:9092"
#     expose:
#       - "9093"
#     environment:
#       KAFKA_ADVERTISED_LISTENERS: INSIDE://kafka:9093,OUTSIDE://kafka:9092
#       KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INSIDE:PLAINTEXT,OUTSIDE:PLAINTEXT
#       KAFKA_LISTENERS: INSIDE://0.0.0.0:9093,OUTSIDE://0.0.0.0:9092
#       KAFKA_INTER_BROKER_LISTENER_NAME: INSIDE
#       KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
# #      KAFKA_ADVERTISED_HOST_NAME: kafka #192.168.99.100
#     volumes:
#       - /var/run/docker.sock:/var/run/docker.sock
#     networks:
#       - internal
#       - external
