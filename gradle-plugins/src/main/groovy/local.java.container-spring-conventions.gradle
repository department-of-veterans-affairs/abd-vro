/**
 * Provides docker container settings
 * Based on https://github.com/department-of-veterans-affairs/lighthouse-di-starter-boot/blob/main/buildSrc/src/main/groovy/starter.java.container-spring-conventions.gradle
 */

plugins {
    id 'org.springframework.boot'
    id 'local.java.container-conventions'
}

bootJar {
    // Use the same filename so that the container-diff doesn't incorrectly report differences
    archiveFileName = "${archiveBaseName.get()}.${archiveExtension.get()}"
}

docker {
    files "build/libs/${bootJar.archiveFileName.get()}",
        "src/docker/entrypoint.sh"

    def dockerArgs=[
        JAR_FILE: bootJar.archiveFileName.get()
    ]
    if(project.hasProperty('healthcheck_port'))
        dockerArgs["HEALTHCHECK_PORT_ARG"] = project.property('healthcheck_port')
    buildArgs(dockerArgs)
}

// VRO runs via docker-compose, so we don't use this
// Leaving it since it is part of VA-starter's convention
dockerRun {
    env 'JAVA_PROFILE': '-Dspring.profiles.include=docker'
}

tasks.dockerPrepare.configure {
    dependsOn(tasks.bootJar)
}
