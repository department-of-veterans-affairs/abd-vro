name: Install build dependencies
description: Installs JDK 17, hadolint, and spectral for Java app builds

runs:
  using: composite
  steps:
    - name: Install Java
      uses: actions/setup-java@v3
      with:
        distribution: temurin
        java-version: '17'
        cache: 'gradle'

    # http://man7.org/linux/man-pages/man1/date.1.html
    - name: Get Date
      id: get-date
      run: echo "::set-output name=date::$(/bin/date -u "+%Y%m%d")"
      shell: bash

    - name: Restore hadolint
      uses: actions/cache@v3
      id: cache-hadolint
      with:
        path: /usr/local/bin/hadolint
        key: hadolint-${{ steps.get-date.outputs.date }}

    - name: Install hadolint
      if: steps.cache-hadolint.outputs.cache-hit != 'true'
      shell: bash
      run: |
        sudo wget -O /usr/local/bin/hadolint \
          "https://github.com/hadolint/hadolint/releases/download/v$HADOLINT_VERSION/hadolint-Linux-x86_64"
        sudo chmod +x /usr/local/bin/hadolint
        hadolint --version
      env:
        HADOLINT_VERSION: '2.10.0'

    - name: Install spectral JSON/YAML linter
      shell: bash
      run: npm install -g @stoplight/spectral-cli@6.4.0

    - name: Install ShellCheck
      shell: bash
      run: |
        sudo apt-get install shellcheck
        which shellcheck
