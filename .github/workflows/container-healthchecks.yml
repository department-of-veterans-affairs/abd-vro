name: "PR: Run Container Health Checks"

on:
  # Allow manual triggering
  workflow_dispatch:

concurrency:
  group: containerHealthChecks-${{ github.ref }}

jobs:
  container-healthcheck:
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout source code"
        uses: actions/checkout@v3

      - name: "Docker build"
        uses: ./.github/actions/build-images

      - name: "Create platform containers with healthchecks"
        shell: bash
        run: |
          COMPOSE_PROFILES="gateway" ./gradlew :dockerComposeUp

      - name: "Create app containers with healthchecks"
        shell: bash
        run: |
          COMPOSE_PROFILES="svc" ./gradlew :app:dockerComposeUp

      - name: "Create domain-cc containers with healthchecks"
        shell: bash
        run: |
          ./gradlew :domain-cc:dockerComposeUp

      - name: "Clean shutdown of all containers"
        shell: bash
        run: |
          COMPOSE_PROFILES="all" ./gradlew dockerComposeDown
