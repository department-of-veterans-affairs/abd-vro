name: "CI: Container Health Checks"

on:
  # Allow manual triggering
  workflow_dispatch:

  # Allow being called by another GitHub Action
  workflow_call:

  pull_request:
    branches: [ develop ]

concurrency:
  group: containerHealthChecks-${{ github.ref }}

env:
  LH_ACCESS_CLIENT_ID: ${{ secrets.LH_ACCESS_CLIENT_ID }}
  LH_PRIVATE_KEY: ${{ secrets.LH_PRIVATE_KEY }}
  SLACK_EXCEPTION_WEBHOOK: "http://mock-slack:20100/slack-messages"
jobs:
  container-healthcheck:
    if: github.repository == 'department-of-veterans-affairs/abd-vro' &&
        ((github.event_name == 'pull_request' && startsWith(github.head_ref, 'dependabot/')) || github.event_name != 'pull_request')
    runs-on: ubuntu-latest

    steps:
      - name: "Checkout source code"
        uses: actions/checkout@v3

      - name: "Docker build"
        uses: ./.github/actions/build-images

      - name: "Create platform containers with healthchecks"
        run: |
          source scripts/setenv.sh
          export -p | sed 's/declare -x //'
          COMPOSE_PROFILES="gateway" ./gradlew :dockerComposeUp

      - name: "Create app containers with healthchecks"
        shell: bash
        run: |
          source scripts/setenv.sh
          COMPOSE_PROFILES="svc" ./gradlew :app:dockerComposeUp

      - name: "Create domain-cc containers with healthchecks"
        shell: bash
        run: |
          source scripts/setenv.sh
          ./gradlew :domain-cc:dockerComposeUp

      - name: "Clean shutdown of all containers"
        if: always()
        shell: bash
        run: |
          COMPOSE_PROFILES="all" ./gradlew dockerComposeDown
