name: "7. (Internal) Deploy secrets from Vault"

on:
  # manual run
  workflow_dispatch:
    inputs:
      target_env:
        description: 'Target LHDI environment'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - qa
        - sandbox
        - prod-test
        - prod

      deploy_secrets:
        description: 'Deploy secrets using self-hosted GitHub runner'
        required: true
        default: false
        type: boolean

      publish_new_image:
        description: 'Publish an updated runner image before deploying secrets?'
        required: true
        default: false
        type: boolean

jobs:
  publish_image:
    name: "Publish GitHub runner image"
    # The image is expected to be in the internal repo
    if: inputs.publish_new_image && (github.repository == 'department-of-veterans-affairs/abd-vro-internal')
    runs-on: ubuntu-latest
    steps:
      - name: "Login to GitHub Container Registry"
        uses: docker/login-action@v2.1.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: "Checkout source code"
        uses: actions/checkout@v3

      - name: "Build image"
        run: |
          docker build -f .github/runner/Dockerfile-set-secrets \
            -t ghcr.io/${{ github.repository }}/vro-set-secrets:$(date '+%Y-%m-%d') \
            -t ghcr.io/${{ github.repository }}/vro-set-secrets:latest \
            .github/runner

      - name: "Publish image"
        run: |
          docker push ghcr.io/${{ github.repository }}/vro-set-secrets:$(date '+%Y-%m-%d')
          docker push ghcr.io/${{ github.repository }}/vro-set-secrets:latest

  gh_runner:
    name: "Start GitHub runner to set ${{ inputs.target_env }} secrets"
    needs: publish_image
    if: always() && inputs.deploy_secrets && (github.repository == 'department-of-veterans-affairs/abd-vro-internal')
    runs-on: ubuntu-latest
    steps:
      - name: "Set up kube config for dev env"
        run: |
          mkdir ~/.kube
          echo -n "${{ secrets.DEV_KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          chmod go-rwx ~/.kube/config

      - name: "Checkout source code"
        uses: actions/checkout@v3

      - name: "Deploy runner (in dev)"
        run: |
          export TARGET_ENV=${{ inputs.target_env }}
          case "${{ inputs.target_env }}" in
            dev|qa|sandbox) export KUBE_CONFIG="${{ secrets.DEV_KUBE_CONFIG }}";;
            prod-test|prod) export KUBE_CONFIG="${{ secrets.PROD_KUBE_CONFIG }}";;
          esac
          # The runner is deployed to dev since it doesn't require signed images.
          # KUBE_CONFIG enables the runner to set secrets in other clusters.

          envsubst < .github/runner/pod-set-secrets.yaml | kubectl -n va-abd-rrd-dev replace --force -f -
