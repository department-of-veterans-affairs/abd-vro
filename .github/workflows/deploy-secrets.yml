name: Deploy secrets from Vault

on:
  # manual run
  workflow_dispatch:

jobs:
  from-vault:
    runs-on: [ self-hosted, Linux ]
    permissions:
      contents: read
      packages: write
    steps:
      - name: "Get secrets from vault"
        id: vault-secrets
        uses: hashicorp/vault-action@v2.4.0
        with:
          url: https://ldx-mapi.lighthouse.va.gov
          caCertificate: ${{ secrets.VAULT_CA_CERT }}
          # The VAULT_TOKEN expires in 1 month; copy it from the Vault UI
          token: ${{ secrets.VAULT_TOKEN }}
          method: token
          exportEnv: false
          secrets: |
            va-abd-rrd/Test-App test-key | TEST_VALUE ;

      - name: Build secrets file
        id: build-secrets-file
        run: |
          echo 'TEST_VALUE=${{ steps.vault-secrets.outputs.TEST_VALUE }}' > vault-secrets.txt
          cat vault-secrets.txt
