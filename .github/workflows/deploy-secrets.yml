name: Deploy secrets from Vault

on:
  # manual run
  workflow_dispatch:
    inputs:
      target_env:
        description: 'Target LHDI environment'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - qa
        - sandbox
        - prod-test
        - prod

jobs:
  from-vault:
    runs-on: [ self-hosted, Linux, vro-runner ]
    permissions:
      contents: read
      packages: write
    steps:
      - name: "Get secrets from vault"
        id: vault-secrets
        uses: hashicorp/vault-action@v2.5.0
        with:
          url: https://ldx-mapi.lighthouse.va.gov
          # The base64 encoded CA Certificate provided by LHDI
          caCertificate: ${{ secrets.VAULT_CA_CERT }}
          # The VAULT_TOKEN expires in 1 month; copy it from the Vault UI
          token: ${{ secrets.VAULT_TOKEN }}
          method: token
          exportEnv: true
          # TODO: don't skip verify
          tlsSkipVerify: true
          secrets: |
            va-abd-rrd/deploy/default/db $.$ | DB_SECRETS ;
            va-abd-rrd/deploy/${{inputs.target_env}} $.$ | TARGETED_DB_SECRETS ;

      - name: "Checkout source code"
        uses: actions/checkout@v3

      - name: "Deploy secrets to K8s"
        run: |
          # Load defaults from VAULT
          eval $(echo "$DB_SECRETS" |  jq -r 'to_entries | .[] | "export \(.key)=\(.value|@sh)"')

          # Override with environment-specific values from VAULT
          eval $(echo "$TARGETED_DB_SECRETS" |  jq -r 'to_entries | .[] | "export \(.key)=\(.value|@sh)"')

          for YAML in helm/kubectl/secrets-*.yaml; do
            envsubst < $YAML
            # envsubst < $YAML | kubectl -n va-abd-rrd-${{ inputs.target_env }} apply -f -
          done
