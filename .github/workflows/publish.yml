name: Publish images

on:
  push:
    branches:
      - main
      - develop

env:
  GITHUB_ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
  COMMIT_SHA: ${{ github.sha }}

jobs:
  call-build-workflow:
    uses: ./.github/workflows/build.yml
    secrets:
      ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}

  publish-image:
    needs: call-build-workflow
    runs-on: ubuntu-latest
    steps:
      - name: Install Java
        uses: actions/setup-java@v3
        with:
          distribution: temurin
          java-version: "17"

      - name: Checkout source code
        uses: actions/checkout@v2

      - name: Build image
        run: |
          ./gradlew docker

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v1.14.1
        with:
          registry: ghcr.io
          username: ${{ secrets.USERNAME }}
          password: ${{ secrets.ACCESS_TOKEN }}

      - name: Tag images
        run: |
          docker tag va/abd_vro-app \
            "ghcr.io/${{ github.repository }}/abd_vro-app:${COMMIT_SHA:0:7}"
          docker tag va/abd_vro-db-init \
            "ghcr.io/${{ github.repository }}/abd_vro-db-init:${COMMIT_SHA:0:7}"
          docker tag va/abd_vro-assessclaimdc7101 \
            "ghcr.io/${{ github.repository }}/abd_vro-assessclaimdc7101:${COMMIT_SHA:0:7}"
          docker tag va/abd_vro-assessclaimdc6602 \
            "ghcr.io/${{ github.repository }}/abd_vro-assessclaimdc6602:${COMMIT_SHA:0:7}"
          docker tag va/abd_vro-pdfgenerator \
            "ghcr.io/${{ github.repository }}/abd_vro-pdfgenerator:${COMMIT_SHA:0:7}"
          docker tag va/abd_vro-service-data-access \
            "ghcr.io/${{ github.repository }}/abd_vro-data-access:${COMMIT_SHA:0:7}"
          # Pull and tag these images to work around https://www.docker.com/increase-rate-limits/
          docker pull postgres:latest
          docker tag postgres:latest \
            "ghcr.io/${{ github.repository }}/abd_vro-postgres:latest"
          docker pull rabbitmq:3
          docker tag rabbitmq:3 \
            "ghcr.io/${{ github.repository }}/abd_vro-rabbitmq:3"

      - name: Push images
        run: |
          docker push "ghcr.io/${{ github.repository }}/abd_vro-app:${COMMIT_SHA:0:7}"
          docker push "ghcr.io/${{ github.repository }}/abd_vro-db-init:${COMMIT_SHA:0:7}"
          # Push the following images to work around https://www.docker.com/increase-rate-limits/
          docker push "ghcr.io/${{ github.repository }}/abd_vro-postgres:latest"
          docker push "ghcr.io/${{ github.repository }}/abd_vro-rabbitmq:3"
          docker push "ghcr.io/${{ github.repository }}/abd_vro-pdfgenerator:${COMMIT_SHA:0:7}"
          docker push "ghcr.io/${{ github.repository }}/abd_vro-assessclaimdc7101:${COMMIT_SHA:0:7}"
          docker push "ghcr.io/${{ github.repository }}/abd_vro-assessclaimdc6602:${COMMIT_SHA:0:7}"
