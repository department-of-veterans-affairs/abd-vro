name: "SecRel check for PRs"

on:
  # Trigger on every code push to all branches
  push:

  # Trigger on all published GitHub Releases
  release:
    types: [ "created" ]

  # Trigger manually
  workflow_dispatch:

env:
  TARGET_ENV: 'dev'
  RUN_TESTS: 'true'

jobs:
  publish-images:
    # only run for the internal repo
    if: github.repository == 'department-of-veterans-affairs/abd-vro-internal'
    outputs:
      vro-images: ${{ steps.publish-images.outputs.images_list }}
      target-env: ${{ env.TARGET_ENV }}
      run-tests: ${{ env.RUN_TESTS }}
    runs-on: ubuntu-latest
    steps:
      - name: "Determine target environment"
        run: |
          echo "ref_name: ${{ github.ref_name }}"
          GRADLE_TESTS=true
          case "${{ github.ref_name }}" in
            # main and sandbox are untested
            # main)    IMAGE_PREFIX="";;
            # sandbox) IMAGE_PREFIX=sandbox;;
            qa)      IMAGE_PREFIX=qa;;
            develop) IMAGE_PREFIX=dev;;
            *)       IMAGE_PREFIX=dev
                     GRADLE_TESTS=false
              ;;
          esac
          echo "TARGET_ENV=${IMAGE_PREFIX}" >> $GITHUB_ENV
          echo "RUN_TESTS=${GRADLE_TESTS}" >> $GITHUB_ENV

      - name: "DEBUG step"
        run: |
          echo "TARGET_ENV: ${{ env.TARGET_ENV }}"
          echo "RUN_TESTS: ${{ env.RUN_TESTS }}"

      - name: "Checkout source code"
        uses: actions/checkout@v3

      - name: "Publish ${{ env.TARGET_ENV }} images to GHCR"
        id: publish-images
        uses: ./.github/actions/publish-images
        with:
          target_env: ${{ env.TARGET_ENV }}
          access_token: ${{ secrets.ACCESS_TOKEN }}
          ghcr_username: ${{ secrets.USERNAME }}
          ghcr_password: ${{ secrets.ACCESS_TOKEN }}
          run_tests: ${{ env.RUN_TESTS }}

  debug-job:
    runs-on: ubuntu-latest
    needs:
      - publish-images
    steps:
      - name: output var
        run: |
          echo "TARGET_ENV: ${{ needs.publish-images.outputs.target-env }}"
          echo "RUN_TESTS: ${{ needs.publish-images.outputs.run-tests }}"
          echo "ref_name: ${{github.ref_name}}"
          echo "publish-images: ${{ needs.publish-images.outputs.vro-images }}"
          export -p | sed 's/declare -x //'

  secrel:
    # only run for the internal repo -- SecRel doesn't work on public repos
    if: github.repository == 'department-of-veterans-affairs/abd-vro-internal'
    name: SecRel Pipeline
    needs: publish-images
    uses: department-of-veterans-affairs/lighthouse-tornado-secrel-pipeline/.github/workflows/pipeline.yml@v4.0.0-rc1
    with:
      config-file: .github/secrel/config4.yml
      images: ${{ needs.publish-images.outputs.vro-images }}
    secrets: inherit
