name: "SecRel workflow"

on:
  pull_request:
    branches: [ main, qa, develop ]
    # Limit to certain PR event types since this action doesn't need to run for every commit
    types: [ready_for_review, review_requested]

  # Trigger on every code push to main and develop branches
#  push:
#    branches: [ main, qa, develop ]

  # Trigger on all published GitHub Releases
  release:
    types: [ "created" ]

  # Trigger manually
  workflow_dispatch:

env:
  # GITHUB_ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
  COMMIT_SHA: ${{ github.sha }}
  TARGET_ENV: 'pr'

jobs:
  build-app-images:
    runs-on: ubuntu-latest
    outputs:
        secrel_images: ${{ steps.secrel_images.outputs.images }}
    steps:
      - name: "Checkout source code"
        uses: actions/checkout@v3

      - name: "Build, test, and publish ${{ env.TARGET_ENV }} images to GHCR"
        uses: ./.github/actions/publish-images
        with:
          target_env: ${{ env.TARGET_ENV }}
          access_token: ${{ secrets.ACCESS_TOKEN }}
          ghcr_username: ${{ secrets.USERNAME }}
          ghcr_password: ${{ secrets.ACCESS_TOKEN }}

      - name: "Generate images string to use in secrel job"
        id: secrel_images
        run: |
          echo -e "images=ghcr.io/${{ github.repository }}/${{ env.TARGET_ENV }}_vro-app:${{ env.COMMIT_SHA }} \n
          ghcr.io/${{ github.repository }}/${{ env.TARGET_ENV }}_vro-postgres:${{ env.COMMIT_SHA }} \n
          ghcr.io/${{ github.repository }}/${{ env.TARGET_ENV }}_vro-db-init:${{ env.COMMIT_SHA }} \n
          ghcr.io/${{ github.repository }}/${{ env.TARGET_ENV }}_vro-console:${{ env.COMMIT_SHA }} \n
          ghcr.io/${{ github.repository }}/${{ env.TARGET_ENV }}_vro-service-data-access:${{ env.COMMIT_SHA }} \n
          ghcr.io/${{ github.repository }}/${{ env.TARGET_ENV }}_vro-service-pdfgenerator:${{ env.COMMIT_SHA }} \n
          ghcr.io/${{ github.repository }}/${{ env.TARGET_ENV }}_vro-service-assessclaimdc7101:${{ env.COMMIT_SHA }} \n
          ghcr.io/${{ github.repository }}/${{ env.TARGET_ENV }}_vro-service-assessclaimdc6602:${{ env.COMMIT_SHA }}" >> $GITHUB_OUTPUT

  secrel:
    # only run for the internal repo
    if: github.repository == 'department-of-veterans-affairs/abd-vro-internal'
    name: Tornado Pipeline
    needs: build-app-images
    uses: department-of-veterans-affairs/lighthouse-tornado-secrel-pipeline/.github/workflows/pipeline.yml@v4.0.0-rc1
    with:
      config-file: .github/secrel/config.yml
      images: ${{ needs.build-app-images.outputs.secrel_images }}
    secrets: inherit
