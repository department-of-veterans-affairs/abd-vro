name: Deploy core services

on:
  workflow_dispatch:
    inputs:
      target_env:
        description: 'Target LHDI environment'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - qa
        - sandbox
        - prod-test
        - prod
      
      target_service:
        description: 'Target LHDI environment'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - core
        - db
        - redis
        - mq
        
      target_release:
        description: 'Target release tag or SHA'
        required: true
        default: 'latest'
        type: string

  # Allow other workflows to call this one
  workflow_call:
    inputs:
      target_env:
        required: true
        type: string
      target_service:
        required: true
        type: string
      target_release:
        required: true
        type: string
env:
  GITHUB_ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
  COMMIT_SHA: ${{ inputs.target_release }}
  SERVICE: ${{ inputs.target_service }}
  DEV_KUBE_CONFIG: ${{ secrets.DEV_KUBE_CONFIG }}
  TARGET_ENV: ${{ inputs.target_env }}
  # Default to failure messages
  DEPLOY_STATE_TEXT: ':panda_shocked: Deployment failed!'
  DEPLOY_STATE_EMOJI: 'x'

jobs:
  deploy-core-services:
    if: github.repository == 'department-of-veterans-affairs/abd-vro'
    runs-on: ubuntu-latest
    steps:
      #- name: "Notify Slack: Deploying..."
      #  id: notify-slack-deploying
      #  uses: archive/github-actions-slack@v2.6.0
      #  with:
      #    slack-bot-user-oauth-access-token: ${{ secrets.SLACK_BOT_USER_OAUTH_ACCESS_TOKEN }}
      #    slack-channel: ${{ fromJson(steps.notify-slack.outputs.slack-result).response.channel }}
      #    slack-optional-thread_ts: ${{ fromJson(steps.notify-slack.outputs.slack-result).response.message.ts }}
      #    slack-text: ":panda_coffee: Deploying services to ${{ env.TARGET_ENV }}..."

      - name: "Set up kube config"
        run: |
          mkdir ~/.kube
          if [ "${{ env.TARGET_ENV }}" == "sandbox" ] || [ "${{ env.TARGET_ENV }}" == "dev" ] || [ "${{ env.TARGET_ENV }}" == "qa" ]
          then
            echo -n "${{ secrets.DEV_KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          else
            echo -n "${{ secrets.PROD_KUBE_CONFIG }}" | base64 -d > ~/.kube/config
          fi

      - name: "Deploy core to ${{ env.TARGET_ENV }} env"
        env:
          GITHUB_ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
          GITHUB_USERNAME: ${{ secrets.USERNAME }}
        run: |
          if [ "${{ env.SERVICE }}" == "all" ] || [ "${{ env.SERVICE }}" == "core" ]
          then
            pwd
            ../scripts/deploy-core.sh ${{ env.TARGET_ENV }}
          fi  

      - name: "Deploy redis to ${{ env.TARGET_ENV }} env"
        env:
          GITHUB_ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
          GITHUB_USERNAME: ${{ secrets.USERNAME }}
        run: |
          if [ "${{ env.SERVICE }}" == "redis" ]
          then
            ./scripts/deploy-${{ env.SERVICE }}.sh ${{ env.TARGET_ENV }} 1
          fi  
      
      - name: "Deploy RabbitMQ to ${{ env.TARGET_ENV }} env"
        env:
          GITHUB_ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
          GITHUB_USERNAME: ${{ secrets.USERNAME }}
        run: |
          if [ "${{ env.SERVICE }}" == "mq" ]
          then
            ./scripts/deploy-${{ env.SERVICE }}.sh ${{ env.TARGET_ENV }} 1 
          fi  

      - name: "Deploy DB to ${{ env.TARGET_ENV }} env"
        env:
          GITHUB_ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
          GITHUB_USERNAME: ${{ secrets.USERNAME }}
        run: |
          if [ "${{ env.SERVICE }}" == "db" ]
          then
            pwd
            ../scripts/deploy-${{ env.SERVICE }}.sh ${{ env.TARGET_ENV }} 1 ${{ env.COMMIT_SHA }}
          fi  
