version: '3.9'

# https://stackoverflow.com/questions/38088279/communication-between-multiple-docker-compose-projects
networks:
  # Put these mock services on the same `internal` network as VRO -- see app/src/docker/docker-compose.yml
  internal:

# Reusable blocks
# https://medium.com/@kinghuang/docker-compose-anchors-aliases-extensions-a1e4105d70bd
# Also note https://yaml.org/type/merge.html

x-common-vars: &common-vars
  # ENV determines which configuration settings to use.
  # ENV=local causes application-local.properties to be used, in addition to the default application.properties
  ENV: ${ENV:-local}

x-common-security-opt: &common-security-opt
  security_opt:
    - no-new-privileges:true

x-common-sde-security: &common-sde-security
  ulimits:
    nproc: 65535

# For port numbering convention, see https://github.com/department-of-veterans-affairs/abd-vro/wiki/Software-Conventions#port-numbers
# - 20NNx = mock service ports, where NN is an index
# - 20NN1 = health check port for mock service NN

services:
  # Containers with the `mock-` prefix are used for development and testing.

  mock-slack:
    profiles: ["all","mock","slack","v2-mocks"]
    image: va/abd_vro-mock-slack:latest
    <<: [*common-sde-security, *common-security-opt]
    ports:
      - "20100:20100"
    environment:
      <<: *common-vars
    networks:
      - internal

  mock-lighthouse-api:
    profiles: ["all","mock","lh","v2-mocks"]
    image: va/abd_vro-mock-lighthouse-api:latest
    <<: [*common-sde-security, *common-security-opt]
    ports:
      - "20200:20200"
    environment:
      <<: *common-vars
      LH_PRIVATE_KEY: ${LH_PRIVATE_KEY}
      LH_ACCESS_CLIENT_ID: ${LH_ACCESS_CLIENT_ID}
    networks:
      - internal

  mock-bip-claims-api:
    profiles: ["all","mock","bip","v2-mocks"]
    image: va/abd_vro-mock-bip-claims-api:latest
    <<: [*common-sde-security, *common-security-opt]
    ports:
      - "20300:20300"
      - "20306:20306"
    environment:
      <<: *common-vars
      BIP_CLAIM_USERID: ${BIP_CLAIM_USERID}
      BIP_CLAIM_SECRET: ${BIP_CLAIM_SECRET}
      BIP_TRUSTSTORE: ${BIP_TRUSTSTORE}
      BIP_KEYSTORE: ${BIP_KEYSTORE}
    networks:
      - internal

  mock-bip-ce-api:
    profiles: ["all","mock","bip","v2-mocks"]
    image: va/abd_vro-mock-bip-ce-api:latest
    <<: [*common-sde-security, *common-security-opt]
    ports:
      - "20310:20310"
      - "20316:20316"
    environment:
      <<: *common-vars
      BIP_EVIDENCE_USERID: ${BIP_EVIDENCE_USERID}
      BIP_EVIDENCE_SECRET: ${BIP_EVIDENCE_SECRET}
#      BIP_APPLICATION_ID: ${BIP_APPLICATION_ID}
      BIP_TRUSTSTORE: ${BIP_TRUSTSTORE}
      BIP_KEYSTORE: ${BIP_KEYSTORE}
    networks:
      - internal

  mock-mas-api:
    profiles: ["all","mock","mas","v2-mocks"]
    image: va/abd_vro-mock-mas-api:latest
    <<: [*common-sde-security, *common-security-opt]
    ports:
      - "20400:20400"
    environment:
      <<: *common-vars
      MAS_API_AUTH_CLIENTID: ${MAS_API_AUTH_CLIENTID}
      MAS_API_AUTH_CLIENT_SECRET: ${MAS_API_AUTH_CLIENT_SECRET}
      MAS_API_AUTH_TOKEN_URI: ${MAS_API_AUTH_TOKEN_URI}
#      MAS_API_AUTH_SCOPE: ${MAS_API_AUTH_SCOPE}
      MAS_API_BASE_URL: ${MAS_API_BASE_URL}
#      MAS_COLLECTION_ANNOTS_PATH: ${MAS_COLLECTION_ANNOTS_PATH}
#      MAS_COLLECTION_STATUS_PATH: ${MAS_COLLECTION_STATUS_PATH}
#      MAS_CREATE_EXAM_ORDER_PATH: ${MAS_CREATE_EXAM_ORDER_PATH}
    networks:
      - internal
